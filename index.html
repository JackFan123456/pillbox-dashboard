<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ™ºæ…§è—¥ç›’ Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f2f2f2; padding:20px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .card {
      background:#fff;
      padding:16px;
      border-radius:12px;
      width:300px;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
    }
    .big { font-size:22px; font-weight:700; margin:6px 0; }
    .muted { color:#666; font-size:14px; }

    .tabs {
      display:flex;
      gap:10px;
      margin: 14px 0 18px;
      flex-wrap:wrap;
    }
    .tab-btn{
      padding:10px 12px;
      border:none;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      background:#eee;
      color:#111;
    }
    .tab-btn.active{
      background:#111;
      color:#fff;
    }

    .page { display:none; }
    .page.active { display:block; }

    .slot { display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; }
    .time-tag{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      background:#eee;
      font-size:13px;
      font-weight:700;
      color:#111;
      letter-spacing:.3px;
    }

    .input, input[type="time"], input[type="text"]{
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      outline: none;
      box-sizing: border-box;
      margin-top: 6px;
      margin-bottom: 10px;
      background: #fff;
    }
    button{
      padding: 10px 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }
    .btn-primary{ background:#111; color:#fff; }
    .btn-ghost{ background:#eee; color:#111; }
    .msg { margin-top: 8px; font-size: 14px; color:#444; }

    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
  </style>
</head>

<body>
<h2>ğŸ’Š æ™ºæ…§è—¥ç›’ Dashboard</h2>

<div class="tabs">
  <button id="tab-status" class="tab-btn active">ğŸ“¡ ç‹€æ…‹ç¸½è¦½</button>
  <button id="tab-config" class="tab-btn">âš™ï¸ æœè—¥è¨­å®š</button>
  <button id="tab-history" class="tab-btn">ğŸ“’ æœè—¥ç´€éŒ„</button>
</div>

<!-- ================= Status Page ================= -->
<div id="page-status" class="page active">
  <div class="row">
    <div class="card">
      <div class="muted">æ™‚æ®µ</div>
      <div class="slot">
        <div class="big">æ—©ï¼ˆMorningï¼‰</div>
        <div id="time-morning" class="time-tag">--:--</div>
      </div>

      <div class="muted">éœ€è¦æœç”¨è—¥ç‰©</div>
      <div id="meds-morning" class="big">--</div>

      <div class="muted">ç‹€æ…‹</div>
      <div id="state-morning" class="big">--</div>

      <div class="muted">æœ€å¾Œæ›´æ–°</div>
      <div id="ts-morning" class="muted">--</div>
    </div>

    <div class="card">
      <div class="muted">æ™‚æ®µ</div>
      <div class="slot">
        <div class="big">ä¸­ï¼ˆNoonï¼‰</div>
        <div id="time-noon" class="time-tag">--:--</div>
      </div>

      <div class="muted">éœ€è¦æœç”¨è—¥ç‰©</div>
      <div id="meds-noon" class="big">--</div>

      <div class="muted">ç‹€æ…‹</div>
      <div id="state-noon" class="big">--</div>

      <div class="muted">æœ€å¾Œæ›´æ–°</div>
      <div id="ts-noon" class="muted">--</div>
    </div>

    <div class="card">
      <div class="muted">æ™‚æ®µ</div>
      <div class="slot">
        <div class="big">æ™šï¼ˆNightï¼‰</div>
        <div id="time-night" class="time-tag">--:--</div>
      </div>

      <div class="muted">éœ€è¦æœç”¨è—¥ç‰©</div>
      <div id="meds-night" class="big">--</div>

      <div class="muted">ç‹€æ…‹</div>
      <div id="state-night" class="big">--</div>

      <div class="muted">æœ€å¾Œæ›´æ–°</div>
      <div id="ts-night" class="muted">--</div>
    </div>
  </div>
</div>

<!-- ================= Config Page ================= -->
<div id="page-config" class="page">
  <div class="row">
    <div class="card" style="width: 640px; max-width: 100%;">
      <div class="big">âš™ï¸ æœè—¥è¨­å®šï¼ˆä¸‹ç™¼åˆ° Picoï¼‰</div>
      <div class="muted">æœƒ POST åˆ° /api/configï¼Œå¾Œç«¯å† publish MQTTï¼ˆretainedï¼‰ã€‚</div>

      <div style="height:10px;"></div>

      <div class="muted">æ—©ï¼ˆmorningï¼‰æ™‚é–“</div>
      <input id="t-morning" type="time" value="08:00">
      <div class="muted">æ—© è—¥å“ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</div>
      <input id="m-morning" type="text" placeholder="æ™®æ‹¿ç–¼1é¡†, ç¶­ä»–å‘½C500mg">

      <div class="muted">ä¸­ï¼ˆnoonï¼‰æ™‚é–“</div>
      <input id="t-noon" type="time" value="12:00">
      <div class="muted">ä¸­ è—¥å“ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</div>
      <input id="m-noon" type="text" placeholder="...">

      <div class="muted">æ™šï¼ˆnightï¼‰æ™‚é–“</div>
      <input id="t-night" type="time" value="20:00">
      <div class="muted">æ™š è—¥å“ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</div>
      <input id="m-night" type="text" placeholder="...">

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="btn-load" class="btn-ghost">è®€å–ç›®å‰è¨­å®š</button>
        <button id="btn-save" class="btn-primary">é€å‡ºè¨­å®šï¼ˆPublish MQTTï¼‰</button>
      </div>

      <div id="save-msg" class="msg"></div>
    </div>
  </div>
</div>

<!-- ================= History Page ================= -->
<div id="page-history" class="page">
  <div class="row">
    <div class="card" style="width: 980px; max-width: 100%;">
      <div class="big">ğŸ“’ éå» 7 å¤©æœè—¥ç´€éŒ„ï¼ˆåªé¡¯ç¤ºæœ€çµ‚çµæœï¼‰</div>
      <div class="muted">è³‡æ–™ä¾†æºï¼šGET /api/history?days=7ï¼ˆDONE / MISSEDï¼‰</div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:12px;">
        <button id="btn-history" class="btn-primary">é‡æ–°è¼‰å…¥</button>
        <div id="history-msg" class="msg"></div>
      </div>

      <div style="overflow:auto; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>æ™‚é–“</th>
              <th>æ™‚æ®µ</th>
              <th>çµæœ</th>
              <th>æœç”¨è—¥å“</th>
            </tr>
          </thead>
          <tbody id="history-body">
            <tr><td colspan="4" class="muted">--</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
/* ========== API è¨­å®š ========== */
// 1. åœ¨é–‹ç™¼æ™‚ï¼Œä½¿ç”¨ "http://127.0.0.1:8000"
// 2. ä½¿ç”¨ ngrok æ™‚ï¼Œæ”¹æˆä¾‹å¦‚ "https://xxxx-xxxx.ngrok-free.app"
// 3. éƒ¨ç½²åˆ° Render æ™‚ï¼Œæ”¹æˆä¾‹å¦‚ "https://your-app.onrender.com"
const API_BASE = "https://approvably-creamlaid-vanetta.ngrok-free.dev";

const API_STATE   = `${API_BASE}/api/state`;
const API_CONFIG  = `${API_BASE}/api/config`;
const API_HISTORY = `${API_BASE}/api/history?days=7`;

/* âœ… çµ±ä¸€æŠŠ ngrok header + no-store æ”¾é€™è£¡ï¼Œæ‰€æœ‰ GET ç›´æ¥ç”¨å®ƒ */
const FETCH_GET_OPTS = {
  cache: "no-store",
  headers: {
    "ngrok-skip-browser-warning": "true"
  }
};

/* âœ… POST ä¹Ÿè¦å¸¶ ngrok headerï¼ˆä½†é‚„è¦ Content-Typeï¼‰ */
function fetchPostJson(url, payloadObj) {
  return fetch(url, {
    method: "POST",
    cache: "no-store",
    headers: {
      "Content-Type": "application/json",
      "ngrok-skip-browser-warning": "true"
    },
    body: JSON.stringify(payloadObj)
  });
}

const STATUS_TEXT = {
  "IDLE": "å¾…æ©Ÿä¸­",
  "ALARMING": "â° æé†’ä¸­",
  "DONE": "âœ… å·²æœè—¥",
  "ACKED": "âœ… å·²æœè—¥",
  "MISSED": "âŒ æ¼æœ"
};

function fmtTs(sec) {
  if (sec === null || sec === undefined) return "--";
  const n = Number(sec);
  if (!Number.isFinite(n) || n <= 0) return "--";
  return new Date(n * 1000).toLocaleString();
}

function renderMeds(meds) {
  if (!meds) return "--";
  if (Array.isArray(meds)) return meds.length ? meds.join("ã€") : "--";
  const s = String(meds).trim();
  return s ? s : "--";
}

function renderTime(t) {
  const s = String(t || "").trim();
  return s ? s : "--:--";
}

function parseMeds(text) {
  return text.split(",").map(s => s.trim()).filter(Boolean);
}

/* ========== State polling ========== */
let stateTimer = null;

async function refreshState() {
  try {
    const r = await fetch(API_STATE, FETCH_GET_OPTS);
    const data = await r.json();

    ["morning", "noon", "night"].forEach(box => {
      const stateEl = document.getElementById(`state-${box}`);
      const tsEl = document.getElementById(`ts-${box}`);

      if (data[box]) {
        stateEl.textContent = STATUS_TEXT[data[box].state] ?? data[box].state;
        tsEl.textContent = fmtTs(data[box].recv_ts);
      } else {
        stateEl.textContent = "--";
        tsEl.textContent = "--";
      }
    });
  } catch (e) {
    ["morning","noon","night"].forEach(box=>{
      document.getElementById(`state-${box}`).textContent = "å¾Œç«¯æœªé€£ç·š";
      document.getElementById(`ts-${box}`).textContent = "--";
    });
  }
}

function startStatePolling() {
  if (stateTimer) return;
  refreshState();
  stateTimer = setInterval(refreshState, 1000);
}

function stopStatePolling() {
  if (!stateTimer) return;
  clearInterval(stateTimer);
  stateTimer = null;
}

/* ========== Config ========== */
function fillFromConfig(cfg) {
  const boxes = cfg?.boxes || {};
  ["morning","noon","night"].forEach(box=>{
    const medsEl = document.getElementById(`meds-${box}`);
    const timeEl = document.getElementById(`time-${box}`);

    if (boxes[box]) {
      const t = boxes[box].time || "00:00";
      const meds = boxes[box].meds || [];

      document.getElementById(`t-${box}`).value = t;
      document.getElementById(`m-${box}`).value = Array.isArray(meds) ? meds.join(", ") : String(meds);

      if (medsEl) medsEl.textContent = renderMeds(meds);
      if (timeEl) timeEl.textContent = renderTime(t);
    } else {
      if (medsEl) medsEl.textContent = "--";
      if (timeEl) timeEl.textContent = "--:--";
    }
  });
}

async function loadConfig() {
  const msg = document.getElementById("save-msg");
  if (msg) msg.textContent = "è®€å–è¨­å®šä¸­...";

  const r = await fetch(API_CONFIG, FETCH_GET_OPTS);
  const cfg = await r.json();
  fillFromConfig(cfg);

  if (msg) msg.textContent = `âœ… å·²è®€å–è¨­å®šï¼ˆæœ€å¾Œè¨­å®šï¼š${fmtTs(cfg.updated_ts)}ï¼‰`;
}

async function saveConfig() {
  const msg = document.getElementById("save-msg");
  if (msg) msg.textContent = "é€å‡ºä¸­...";

  const payload = {
    boxes: {
      morning: { time: document.getElementById("t-morning").value, meds: parseMeds(document.getElementById("m-morning").value) },
      noon:    { time: document.getElementById("t-noon").value,    meds: parseMeds(document.getElementById("m-noon").value) },
      night:   { time: document.getElementById("t-night").value,   meds: parseMeds(document.getElementById("m-night").value) },
    }
  };

  const r = await fetchPostJson(API_CONFIG, payload);
  const data = await r.json();
  if (!r.ok) throw new Error(data.detail || "POST /api/config failed");

  if (msg) msg.textContent = `âœ… å·²é€å‡ºè¨­å®šä¸¦ publish MQTTï¼ˆæœ€å¾Œè¨­å®šï¼š${fmtTs(data.updated_ts)}ï¼‰`;

  loadConfig().catch(()=>{});
}

/* ========== History ========== */
function boxLabel(box){
  if (box === "morning") return "æ—©ï¼ˆMorningï¼‰";
  if (box === "noon") return "ä¸­ï¼ˆNoonï¼‰";
  if (box === "night") return "æ™šï¼ˆNightï¼‰";
  return box || "--";
}

function stateLabel(st){
  return STATUS_TEXT[st] ?? (st || "--");
}

async function loadHistory(){
  const msg = document.getElementById("history-msg");
  const body = document.getElementById("history-body");
  if (msg) msg.textContent = "è¼‰å…¥ä¸­...";

  const r = await fetch(API_HISTORY, FETCH_GET_OPTS);
  const data = await r.json();
  if (!r.ok) throw new Error(data.detail || "GET /api/history failed");

  const rows = (data.rows || []).filter(x => (x.state === "DONE" || x.state === "MISSED"));

  if (!rows.length) {
    body.innerHTML = `<tr><td colspan="4" class="muted">ï¼ˆè¿‘ 7 å¤©æ²’æœ‰æœ€çµ‚çµæœç´€éŒ„ï¼‰</td></tr>`;
    if (msg) msg.textContent = "âœ… å·²è¼‰å…¥ï¼ˆ0 ç­†ï¼‰";
    return;
  }

  body.innerHTML = rows.map(x => {
    const timeStr = x.device_ts ? x.device_ts : fmtTs(x.recv_ts);
    const medsStr = renderMeds(x.meds || []);
    return `
      <tr>
        <td>${timeStr}</td>
        <td>${boxLabel(x.box)}</td>
        <td>${stateLabel(x.state)}</td>
        <td>${medsStr}</td>
      </tr>
    `;
  }).join("");

  if (msg) msg.textContent = `âœ… å·²è¼‰å…¥ï¼ˆ${rows.length} ç­†ï¼‰`;
}

/* ========== Tabs ========== */
function setActiveTab(which) {
  const tabStatus = document.getElementById("tab-status");
  const tabConfig = document.getElementById("tab-config");
  const tabHistory = document.getElementById("tab-history");

  const pageStatus = document.getElementById("page-status");
  const pageConfig = document.getElementById("page-config");
  const pageHistory = document.getElementById("page-history");

  [tabStatus, tabConfig, tabHistory].forEach(x => x.classList.remove("active"));
  [pageStatus, pageConfig, pageHistory].forEach(x => x.classList.remove("active"));

  if (which === "status") {
    tabStatus.classList.add("active");
    pageStatus.classList.add("active");
    startStatePolling();
  } else if (which === "config") {
    tabConfig.classList.add("active");
    pageConfig.classList.add("active");
    stopStatePolling();
    loadConfig().catch(()=>{});
  } else {
    tabHistory.classList.add("active");
    pageHistory.classList.add("active");
    stopStatePolling();
    loadHistory().catch(err=>{
      document.getElementById("history-msg").textContent = `âŒ è¼‰å…¥å¤±æ•—ï¼š${err.message}`;
    });
  }
}

document.getElementById("tab-status").addEventListener("click", () => setActiveTab("status"));
document.getElementById("tab-config").addEventListener("click", () => setActiveTab("config"));
document.getElementById("tab-history").addEventListener("click", () => setActiveTab("history"));

document.getElementById("btn-load").addEventListener("click", () => {
  loadConfig().catch(err => {
    document.getElementById("save-msg").textContent = `âŒ è®€å–å¤±æ•—ï¼š${err.message}`;
  });
});

document.getElementById("btn-save").addEventListener("click", () => {
  saveConfig().catch(err => {
    document.getElementById("save-msg").textContent = `âŒ é€å‡ºå¤±æ•—ï¼š${err.message}`;
  });
});

document.getElementById("btn-history").addEventListener("click", () => {
  loadHistory().catch(err => {
    document.getElementById("history-msg").textContent = `âŒ è¼‰å…¥å¤±æ•—ï¼š${err.message}`;
  });
});

/* ========== init ========== */
loadConfig().catch(()=>{});
setActiveTab("status");
</script>
</body>
</html>
