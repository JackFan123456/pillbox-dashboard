<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ™ºæ…§è—¥ç›’ Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f2f2f2; padding:20px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .card {
      background:#fff;
      padding:16px;
      border-radius:12px;
      width:300px;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
    }
    .big { font-size:22px; font-weight:700; margin:6px 0; }
    .muted { color:#666; font-size:14px; }

    .tabs { display:flex; gap:10px; margin:14px 0 18px; flex-wrap:wrap; }
    .tab-btn{
      padding:10px 12px;
      border:none;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      background:#eee;
      color:#111;
    }
    .tab-btn.active{ background:#111; color:#fff; }

    .page { display:none; }
    .page.active { display:block; }

    .slot { display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; }
    .time-tag{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      background:#eee;
      font-size:13px;
      font-weight:700;
      color:#111;
      letter-spacing:.3px;
    }

    .input, input[type="time"], input[type="text"]{
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      outline: none;
      box-sizing: border-box;
      margin-top: 6px;
      margin-bottom: 10px;
      background: #fff;
    }
    button{
      padding: 10px 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }
    .btn-primary{ background:#111; color:#fff; }
    .btn-ghost{ background:#eee; color:#111; }
    .msg { margin-top: 8px; font-size: 14px; color:#444; }

    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; }

    /* ===== Calendar styles ===== */
    .calendar-wrap { margin-top: 10px; }
    .cal-head {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 8px;
      margin-bottom: 10px;
    }
    .cal-title { font-weight:900; font-size:18px; }
    .cal-grid {
      display:grid;
      grid-template-columns: repeat(7, minmax(90px, 1fr));
      gap:10px;
    }
    .dow {
      font-size:13px;
      font-weight:900;
      color:#666;
      text-align:center;
      padding:6px 0;
    }
    .day-cell {
      background:#fff;
      border:1px solid #eee;
      border-radius:14px;
      padding:10px;
      min-height:88px;
      box-shadow:0 1px 8px rgba(0,0,0,.05);
      cursor:pointer;
      position:relative;
      transition: transform .05s ease;
    }
    .day-cell:hover { transform: translateY(-1px); }
    .day-cell.dim { opacity:.45; }
    .day-cell.selected { outline: 2px solid #111; }
    .day-num { font-weight:900; font-size:16px; }
    .badges { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .badge {
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:4px 8px;
      border-radius:999px;
      background:#f3f3f3;
      font-size:12px;
      font-weight:800;
    }

    /* day summary colors */
    .day-cell.ok { background:#eef8f0; }     /* å…¨ DONE */
    .day-cell.mixed { background:#fff7e6; }  /* DONE+MISSED */
    .day-cell.bad { background:#fdeeee; }    /* æœ‰ MISSED */
    .day-cell.none { background:#ffffff; }   /* æ²’è³‡æ–™ */

    /* picker */
    .select {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      font-weight: 800;
    }

    /* ===== æ”¾å¤§ã€Œé¸å–æ—¥æœŸã€è©³ç´°æ¸…å–®å­—é«” ===== */
    .detail-title{
      font-size: 18px;      /* åŸæœ¬åå°ï¼Œæ”¾å¤§æ¨™é¡Œ */
      font-weight: 900;
    }

    .detail-item{
      padding: 14px 0;      /* è¡Œè·æ›´èˆ’æœ */
    }

    .detail-left > div:first-child{
      font-size: 16px;      /* æ™‚é–“ + æ™‚æ®µé‚£è¡Œ */
      font-weight: 800;
    }

    .detail-left .muted{
      font-size: 15px;      /* è—¥å“é‚£è¡Œ */
      line-height: 1.6;
    }

    .pill{
      font-size: 14px;      /* å³å´ã€Œå·²æœè—¥/æ¼æœã€è† å›Š */
      padding: 6px 10px;
    }
  </style>
</head>

<body>
<h2>ğŸ’Š æ™ºæ…§è—¥ç›’ Dashboard</h2>

<div class="tabs">
  <button id="tab-status" class="tab-btn active">ğŸ“¡ ç‹€æ…‹ç¸½è¦½</button>
  <button id="tab-config" class="tab-btn">âš™ï¸ æœè—¥è¨­å®š</button>
  <button id="tab-history" class="tab-btn">ğŸ“’ æœè—¥ç´€éŒ„</button>
</div>

<!-- ================= Status Page ================= -->
<div id="page-status" class="page active">
  <div class="row">
    <div class="card">
      <div class="muted">æ™‚æ®µ</div>
      <div class="slot">
        <div class="big">æ—©ï¼ˆMorningï¼‰</div>
        <div id="time-morning" class="time-tag">--:--</div>
      </div>

      <div class="muted">éœ€è¦æœç”¨è—¥ç‰©</div>
      <div id="meds-morning" class="big">--</div>

      <div class="muted">ç‹€æ…‹</div>
      <div id="state-morning" class="big">--</div>

      <div class="muted">æœ€å¾Œæ›´æ–°</div>
      <div id="ts-morning" class="muted">--</div>
    </div>

    <div class="card">
      <div class="muted">æ™‚æ®µ</div>
      <div class="slot">
        <div class="big">ä¸­ï¼ˆNoonï¼‰</div>
        <div id="time-noon" class="time-tag">--:--</div>
      </div>

      <div class="muted">éœ€è¦æœç”¨è—¥ç‰©</div>
      <div id="meds-noon" class="big">--</div>

      <div class="muted">ç‹€æ…‹</div>
      <div id="state-noon" class="big">--</div>

      <div class="muted">æœ€å¾Œæ›´æ–°</div>
      <div id="ts-noon" class="muted">--</div>
    </div>

    <div class="card">
      <div class="muted">æ™‚æ®µ</div>
      <div class="slot">
        <div class="big">æ™šï¼ˆNightï¼‰</div>
        <div id="time-night" class="time-tag">--:--</div>
      </div>

      <div class="muted">éœ€è¦æœç”¨è—¥ç‰©</div>
      <div id="meds-night" class="big">--</div>

      <div class="muted">ç‹€æ…‹</div>
      <div id="state-night" class="big">--</div>

      <div class="muted">æœ€å¾Œæ›´æ–°</div>
      <div id="ts-night" class="muted">--</div>
    </div>
  </div>
</div>

<!-- ================= Config Page ================= -->
<div id="page-config" class="page">
  <div class="row">
    <div class="card" style="width: 640px; max-width: 100%;">
      <div class="big">âš™ï¸ æœè—¥è¨­å®šï¼ˆä¸‹ç™¼åˆ° Picoï¼‰</div>
      <div class="muted">æœƒ POST åˆ° /api/configï¼Œå¾Œç«¯å† publish MQTTï¼ˆretainedï¼‰ã€‚</div>

      <div style="height:10px;"></div>

      <div class="muted">æ—©ï¼ˆmorningï¼‰æ™‚é–“</div>
      <input id="t-morning" type="time" value="08:00">
      <div class="muted">æ—© è—¥å“ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</div>
      <input id="m-morning" type="text" placeholder="æ™®æ‹¿ç–¼1é¡†, ç¶­ä»–å‘½C500mg">

      <div class="muted">ä¸­ï¼ˆnoonï¼‰æ™‚é–“</div>
      <input id="t-noon" type="time" value="12:00">
      <div class="muted">ä¸­ è—¥å“ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</div>
      <input id="m-noon" type="text" placeholder="...">

      <div class="muted">æ™šï¼ˆnightï¼‰æ™‚é–“</div>
      <input id="t-night" type="time" value="20:00">
      <div class="muted">æ™š è—¥å“ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</div>
      <input id="m-night" type="text" placeholder="...">

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="btn-load" class="btn-ghost">è®€å–ç›®å‰è¨­å®š</button>
        <button id="btn-save" class="btn-primary">é€å‡ºè¨­å®šï¼ˆPublish MQTTï¼‰</button>
      </div>

      <div id="save-msg" class="msg"></div>
    </div>
  </div>
</div>

<!-- ================= History Page ================= -->
<div id="page-history" class="page">
  <div class="row">
    <div class="card" style="width: 980px; max-width: 100%;">
      <div class="big">ğŸ“’ æœˆæ›†å¼æœè—¥ç´€éŒ„</div>
      <div class="muted">è³‡æ–™ä¾†æºï¼šGET /api/history?days=30ï¼ˆDONE / MISSEDï¼‰ã€‚æ ¼å­é¡è‰²ï¼šâœ…=æ·¡ç¶ ã€âŒ=æ·¡ç´…ã€æ··åˆ=æ·¡é»ƒã€‚</div>

      <div class="cal-head">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button id="btn-prev-month" class="btn-ghost">â—€ ä¸Šå€‹æœˆ</button>
          <button id="btn-today" class="btn-ghost">ä»Šå¤©</button>
          <select id="month-picker" class="select"></select>
          <button id="btn-next-month" class="btn-ghost">ä¸‹å€‹æœˆ â–¶</button>
        </div>
        <div id="cal-title" class="cal-title">--</div>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:4px;">
        <button id="btn-history" class="btn-primary">é‡æ–°è¼‰å…¥ï¼ˆè¿‘ 30 å¤©ï¼‰</button>
        <div id="history-msg" class="msg"></div>
      </div>

      <div class="calendar-wrap">
        <div class="cal-grid" id="dow-row">
          <div class="dow">ä¸€</div><div class="dow">äºŒ</div><div class="dow">ä¸‰</div><div class="dow">å››</div><div class="dow">äº”</div><div class="dow">å…­</div><div class="dow">æ—¥</div>
        </div>
        <div class="cal-grid" id="cal-grid"></div>

        <div class="detail-box">
          <div id="detail-title" class="detail-title">é¸å–æ—¥æœŸï¼š--</div>
          <div id="detail-list" class="muted">é»é¸ä¸Šæ–¹æ—¥æœŸæ ¼å­æŸ¥çœ‹è©³ç´°ç´€éŒ„</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ========== API è¨­å®š ========== */
const API_BASE = "https://approvably-creamlaid-vanetta.ngrok-free.dev";

const API_STATE   = `${API_BASE}/api/state`;
const API_CONFIG  = `${API_BASE}/api/config`;
const API_HISTORY = `${API_BASE}/api/history?days=30`; // âœ… æœˆæ›†å»ºè­°è‡³å°‘ 30 å¤©

const FETCH_GET_OPTS = {
  cache: "no-store",
  headers: {
    "ngrok-skip-browser-warning": "true"
  }
};

function fetchPostJson(url, payloadObj) {
  return fetch(url, {
    method: "POST",
    cache: "no-store",
    headers: {
      "Content-Type": "application/json",
      "ngrok-skip-browser-warning": "true"
    },
    body: JSON.stringify(payloadObj)
  });
}

const STATUS_TEXT = {
  "IDLE": "å¾…æ©Ÿä¸­",
  "ALARMING": "â° æé†’ä¸­",
  "DONE": "âœ… å·²æœè—¥",
  "ACKED": "âœ… å·²æœè—¥",
  "MISSED": "âŒ æ¼æœ"
};

function fmtTs(sec) {
  if (sec === null || sec === undefined) return "--";
  const n = Number(sec);
  if (!Number.isFinite(n) || n <= 0) return "--";
  return new Date(n * 1000).toLocaleString();
}

function renderMeds(meds) {
  if (!meds) return "--";
  if (Array.isArray(meds)) return meds.length ? meds.join("ã€") : "--";
  const s = String(meds).trim();
  return s ? s : "--";
}

function renderTime(t) {
  const s = String(t || "").trim();
  return s ? s : "--:--";
}

function parseMeds(text) {
  return text.split(",").map(s => s.trim()).filter(Boolean);
}

/* ========== State polling ========== */
let stateTimer = null;

async function refreshState() {
  try {
    const r = await fetch(API_STATE, FETCH_GET_OPTS);
    const data = await r.json();

    ["morning", "noon", "night"].forEach(box => {
      const stateEl = document.getElementById(`state-${box}`);
      const tsEl = document.getElementById(`ts-${box}`);

      if (data[box]) {
        stateEl.textContent = STATUS_TEXT[data[box].state] ?? data[box].state;
        tsEl.textContent = fmtTs(data[box].recv_ts);
      } else {
        stateEl.textContent = "--";
        tsEl.textContent = "--";
      }
    });
  } catch (e) {
    ["morning","noon","night"].forEach(box=>{
      document.getElementById(`state-${box}`).textContent = "å¾Œç«¯æœªé€£ç·š";
      document.getElementById(`ts-${box}`).textContent = "--";
    });
  }
}

function startStatePolling() {
  if (stateTimer) return;
  refreshState();
  stateTimer = setInterval(refreshState, 1000);
}

function stopStatePolling() {
  if (!stateTimer) return;
  clearInterval(stateTimer);
  stateTimer = null;
}

/* ========== Config ========== */
function fillFromConfig(cfg) {
  const boxes = cfg?.boxes || {};
  ["morning","noon","night"].forEach(box=>{
    const medsEl = document.getElementById(`meds-${box}`);
    const timeEl = document.getElementById(`time-${box}`);

    if (boxes[box]) {
      const t = boxes[box].time || "00:00";
      const meds = boxes[box].meds || [];

      document.getElementById(`t-${box}`).value = t;
      document.getElementById(`m-${box}`).value = Array.isArray(meds) ? meds.join(", ") : String(meds);

      if (medsEl) medsEl.textContent = renderMeds(meds);
      if (timeEl) timeEl.textContent = renderTime(t);
    } else {
      if (medsEl) medsEl.textContent = "--";
      if (timeEl) timeEl.textContent = "--:--";
    }
  });
}

async function loadConfig() {
  const msg = document.getElementById("save-msg");
  if (msg) msg.textContent = "è®€å–è¨­å®šä¸­...";

  const r = await fetch(API_CONFIG, FETCH_GET_OPTS);
  const cfg = await r.json();
  fillFromConfig(cfg);

  if (msg) msg.textContent = `âœ… å·²è®€å–è¨­å®šï¼ˆæœ€å¾Œè¨­å®šï¼š${fmtTs(cfg.updated_ts)}ï¼‰`;
}

async function saveConfig() {
  const msg = document.getElementById("save-msg");
  if (msg) msg.textContent = "é€å‡ºä¸­...";

  const payload = {
    boxes: {
      morning: { time: document.getElementById("t-morning").value, meds: parseMeds(document.getElementById("m-morning").value) },
      noon:    { time: document.getElementById("t-noon").value,    meds: parseMeds(document.getElementById("m-noon").value) },
      night:   { time: document.getElementById("t-night").value,   meds: parseMeds(document.getElementById("m-night").value) },
    }
  };

  const r = await fetchPostJson(API_CONFIG, payload);
  const data = await r.json();
  if (!r.ok) throw new Error(data.detail || "POST /api/config failed");

  if (msg) msg.textContent = `âœ… å·²é€å‡ºè¨­å®šä¸¦ publish MQTTï¼ˆæœ€å¾Œè¨­å®šï¼š${fmtTs(data.updated_ts)}ï¼‰`;

  loadConfig().catch(()=>{});
}

/* ========== Calendar History (Month view) ========== */
let historyRows = [];         // raw rows from /api/history
let dayMap = new Map();       // key: YYYY-MM-DD -> rows[]
let calCursor = new Date();   // current month view cursor
let selectedDateStr = null;   // YYYY-MM-DD

function pad2(n){ return String(n).padStart(2,"0"); }
function ymd(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function monthKey(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }

function parseDateStr(s) {
  // s: YYYY-MM-DD
  const [y,m,dd] = s.split("-").map(Number);
  return new Date(y, m-1, dd);
}

function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }

function mondayBasedDow(d){
  // return 0..6 (Mon..Sun)
  const js = d.getDay(); // 0 Sun..6 Sat
  return (js + 6) % 7;   // Mon=0 ... Sun=6
}

function monthTitle(d){
  return `${d.getFullYear()} å¹´ ${pad2(d.getMonth()+1)} æœˆ`;
}

function buildDayMap(rows){
  const m = new Map();
  for (const x of rows) {
    const ts = x.device_ts ? String(x.device_ts) : "";
    const dateStr = ts ? ts.slice(0,10) : null; // "YYYY-MM-DD"
    if (!dateStr) continue;
    if (!m.has(dateStr)) m.set(dateStr, []);
    m.get(dateStr).push(x);
  }
  // sort within day by time desc if possible
  for (const [k, arr] of m.entries()) {
    arr.sort((a,b) => {
      const ta = (a.device_ts || "").slice(11,19);
      const tb = (b.device_ts || "").slice(11,19);
      return tb.localeCompare(ta);
    });
  }
  return m;
}

function daySummaryClass(rows) {
  if (!rows || !rows.length) return "none";
  const doneCnt = rows.filter(r => r.state === "DONE").length;
  const missCnt = rows.filter(r => r.state === "MISSED").length;
  if (missCnt > 0 && doneCnt === 0) return "bad";
  if (missCnt > 0 && doneCnt > 0) return "mixed";
  if (missCnt === 0 && doneCnt > 0) return "ok";
  return "none";
}

function buildMonthPicker() {
  const sel = document.getElementById("month-picker");
  if (!sel) return;

  const base = new Date();
  const start = new Date(base.getFullYear(), base.getMonth() - 12, 1);

  sel.innerHTML = "";
  for (let i = 0; i < 25; i++) {
    const d = new Date(start.getFullYear(), start.getMonth() + i, 1);
    const opt = document.createElement("option");
    opt.value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    opt.textContent = `${d.getFullYear()} / ${pad2(d.getMonth()+1)}`;
    sel.appendChild(opt);
  }

  sel.value = monthKey(calCursor);
}

function setMonthPickerToCursor() {
  const sel = document.getElementById("month-picker");
  if (!sel) return;
  sel.value = monthKey(calCursor);
}

function renderCalendar(){
  const gridEl = document.getElementById("cal-grid");
  const titleEl = document.getElementById("cal-title");
  titleEl.textContent = monthTitle(calCursor);

  buildMonthPicker();
  setMonthPickerToCursor();

  const m0 = startOfMonth(calCursor);
  const m1 = endOfMonth(calCursor);

  const start = new Date(m0);
  start.setDate(start.getDate() - mondayBasedDow(m0)); // back to Monday

  const end = new Date(m1);
  end.setDate(end.getDate() + (6 - mondayBasedDow(m1))); // forward to Sunday

  const cells = [];
  for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
    const dateStr = ymd(d);
    const isThisMonth = d.getMonth() === calCursor.getMonth();
    const rows = dayMap.get(dateStr) || [];
    const cls = daySummaryClass(rows);
    const isSelected = selectedDateStr === dateStr;

    const doneCnt = rows.filter(r => r.state === "DONE").length;
    const missCnt = rows.filter(r => r.state === "MISSED").length;

    let badges = "";
    if (doneCnt) badges += `<span class="badge">âœ… ${doneCnt}</span>`;
    if (missCnt) badges += `<span class="badge">âŒ ${missCnt}</span>`;
    if (!badges) badges = `<span class="badge">â€”</span>`;

    cells.push(`
      <div class="day-cell ${cls} ${isThisMonth ? "" : "dim"} ${isSelected ? "selected" : ""}" data-date="${dateStr}">
        <div class="day-num">${d.getDate()}</div>
        <div class="badges">${badges}</div>
      </div>
    `);
  }

  gridEl.innerHTML = cells.join("");

  // click handlers
  gridEl.querySelectorAll(".day-cell").forEach(el => {
    el.addEventListener("click", () => {
      selectedDateStr = el.getAttribute("data-date");
      renderCalendar();
      renderDayDetails(selectedDateStr);
    });
  });

  // auto pick selected date if missing
  if (!selectedDateStr) {
    selectedDateStr = ymd(new Date());
    renderDayDetails(selectedDateStr);
    // rerender to show selected outline
    renderCalendar();
    return;
  }
}

function boxLabel(box){
  if (box === "morning") return "æ—©ï¼ˆMorningï¼‰";
  if (box === "noon") return "ä¸­ï¼ˆNoonï¼‰";
  if (box === "night") return "æ™šï¼ˆNightï¼‰";
  return box || "--";
}

function stateLabel(st){
  return STATUS_TEXT[st] ?? (st || "--");
}

function renderDayDetails(dateStr){
  const title = document.getElementById("detail-title");
  const list = document.getElementById("detail-list");

  title.textContent = `é¸å–æ—¥æœŸï¼š${dateStr}`;

  const rows = (dayMap.get(dateStr) || []).slice();

  if (!rows.length) {
    list.className = "muted";
    list.textContent = "ï¼ˆç•¶å¤©æ²’æœ‰ DONE / MISSED ç´€éŒ„ï¼‰";
    return;
  }

  list.className = "";
  list.innerHTML = rows.map(x => {
    const timeStr = x.device_ts ? String(x.device_ts).slice(11,19) : "--:--:--";
    const medsStr = renderMeds(x.meds || []);
    const pill = (x.state === "DONE")
      ? `<span class="pill">âœ… å·²æœè—¥</span>`
      : `<span class="pill">âŒ æ¼æœ</span>`;

    return `
      <div class="detail-item">
        <div class="detail-left">
          <div><b>${timeStr}</b>ã€€${boxLabel(x.box)}</div>
          <div class="muted">è—¥å“ï¼š${medsStr}</div>
        </div>
        <div>${pill}</div>
      </div>
    `;
  }).join("");
}

async function loadHistory(){
  const msg = document.getElementById("history-msg");
  if (msg) msg.textContent = "è¼‰å…¥ä¸­...";

  const r = await fetch(API_HISTORY, FETCH_GET_OPTS);
  const data = await r.json();
  if (!r.ok) throw new Error(data.detail || "GET /api/history failed");

  historyRows = (data.rows || []).filter(x => (x.state === "DONE" || x.state === "MISSED"));
  dayMap = buildDayMap(historyRows);

  if (msg) msg.textContent = `âœ… å·²è¼‰å…¥ï¼ˆ${historyRows.length} ç­†ï¼Œè¿‘ ${data.days ?? 30} å¤©ï¼‰`;

  // keep cursor on current month by default
  renderCalendar();
}

/* ========== Tabs ========== */
function setActiveTab(which) {
  const tabStatus = document.getElementById("tab-status");
  const tabConfig = document.getElementById("tab-config");
  const tabHistory = document.getElementById("tab-history");

  const pageStatus = document.getElementById("page-status");
  const pageConfig = document.getElementById("page-config");
  const pageHistory = document.getElementById("page-history");

  [tabStatus, tabConfig, tabHistory].forEach(x => x.classList.remove("active"));
  [pageStatus, pageConfig, pageHistory].forEach(x => x.classList.remove("active"));

  if (which === "status") {
    tabStatus.classList.add("active");
    pageStatus.classList.add("active");
    startStatePolling();
  } else if (which === "config") {
    tabConfig.classList.add("active");
    pageConfig.classList.add("active");
    stopStatePolling();
    loadConfig().catch(()=>{});
  } else {
    tabHistory.classList.add("active");
    pageHistory.classList.add("active");
    stopStatePolling();
    loadHistory().catch(err=>{
      document.getElementById("history-msg").textContent = `âŒ è¼‰å…¥å¤±æ•—ï¼š${err.message}`;
    });
  }
}

/* ========== Events ========== */
document.getElementById("tab-status").addEventListener("click", () => setActiveTab("status"));
document.getElementById("tab-config").addEventListener("click", () => setActiveTab("config"));
document.getElementById("tab-history").addEventListener("click", () => setActiveTab("history"));

document.getElementById("btn-load").addEventListener("click", () => {
  loadConfig().catch(err => {
    document.getElementById("save-msg").textContent = `âŒ è®€å–å¤±æ•—ï¼š${err.message}`;
  });
});

document.getElementById("btn-save").addEventListener("click", () => {
  saveConfig().catch(err => {
    document.getElementById("save-msg").textContent = `âŒ é€å‡ºå¤±æ•—ï¼š${err.message}`;
  });
});

// calendar controls
document.getElementById("btn-history").addEventListener("click", () => {
  loadHistory().catch(err => {
    document.getElementById("history-msg").textContent = `âŒ è¼‰å…¥å¤±æ•—ï¼š${err.message}`;
  });
});

document.getElementById("btn-prev-month").addEventListener("click", () => {
  calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth() - 1, 1);
  selectedDateStr = null;
  renderCalendar();
});

document.getElementById("btn-next-month").addEventListener("click", () => {
  calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth() + 1, 1);
  selectedDateStr = null;
  renderCalendar();
});

document.getElementById("btn-today").addEventListener("click", () => {
  calCursor = new Date();
  selectedDateStr = ymd(new Date());
  renderCalendar();
  renderDayDetails(selectedDateStr);
});

document.getElementById("month-picker").addEventListener("change", (e) => {
  const v = e.target.value; // YYYY-MM
  const [y, m] = v.split("-").map(Number);
  calCursor = new Date(y, m - 1, 1);
  selectedDateStr = null;
  renderCalendar();
});

/* ========== init ========== */
loadConfig().catch(()=>{});
setActiveTab("status");
</script>
</body>
</html>
