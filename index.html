<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ™ºæ…§è—¥ç›’ Dashboard</title>
  <style>
    :root{
      --bg:#f2f2f2;
      --card:#fff;
      --text:#111;
      --muted:#666;
      --line:#eee;
      --shadow:0 2px 10px rgba(0,0,0,.08);
      --radius:14px;
      --focus: 3px solid rgba(17,17,17,.35);
    }

    /* base */
    *{ box-sizing:border-box; }
    body{
      font-family: Arial, sans-serif;
      background:var(--bg);
      margin:0;
      padding:20px;
      color:var(--text);
    }

    /* âœ… ç‰ˆé¢ç½®ä¸­ï¼šæ‰€æœ‰å…§å®¹åŒ…åœ¨ container */
    .container{
      max-width: 1100px;
      margin: 0 auto;
      width: 100%;
    }

    header h2{
      margin: 0 0 12px;
      display:flex;
      align-items:center;
      gap:10px;
      font-size: 26px;
      font-weight: 900;
    }

    /* âœ… tabs ç„¡éšœç¤™ + ç½®ä¸­ */
    .tabs{
      display:flex;
      gap:10px;
      margin: 12px 0 18px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tab-btn{
      padding:10px 12px;
      border:none;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      background:#eee;
      color:#111;
    }
    .tab-btn.active{ background:#111; color:#fff; }
    .tab-btn:focus-visible{ outline: var(--focus); outline-offset: 2px; }

    /* pages */
    .page { display:none; }
    .page.active { display:block; }

    /* layout rows */
    .row{
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      align-items:stretch;
    }

    /* cards */
    .card{
      background:var(--card);
      padding:16px;
      border-radius:var(--radius);
      width:300px;
      box-shadow:var(--shadow);
    }
    .big{ font-size:22px; font-weight:800; margin:6px 0; }
    .muted{ color:var(--muted); font-size:14px; }

    .slot{ display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; }
    .time-tag{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      background:#eee;
      font-size:13px;
      font-weight:800;
      color:#111;
      letter-spacing:.3px;
    }

    /* inputs/buttons */
    input[type="time"], input[type="text"]{
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      outline: none;
      margin-top: 6px;
      margin-bottom: 10px;
      background: #fff;
      font-size: 16px; /* âœ… æ‰‹æ©Ÿé¿å…ç¸®æ”¾/å¤ªå° */
    }
    input:focus-visible{ outline: var(--focus); outline-offset: 2px; }

    button{
      padding: 10px 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 900;
    }
    .btn-primary{ background:#111; color:#fff; }
    .btn-ghost{ background:#eee; color:#111; }
    button:focus-visible{ outline: var(--focus); outline-offset: 2px; }

    .msg{ margin-top: 8px; font-size: 14px; color:#444; }

    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:10px; border-bottom:1px solid #eee; text-align:left; }

    /* ===== Calendar styles ===== */
    .calendar-wrap{ margin-top: 10px; }

    /* âœ… æœˆæ›†å¡ç‰‡ï¼šæ‰‹æ©Ÿä¸è£åˆ‡ï¼Œå…è¨±æ©«å‘æ»‘å‹• */
    .calendar-scroller{
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 6px;
    }

    .cal-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 8px;
      margin-bottom: 10px;
    }
    .cal-title{ font-weight:900; font-size:18px; }

    /* âœ… gridï¼šæ¡Œæ©Ÿ 7 æ¬„ï¼Œæ‰‹æ©Ÿå¯ä»¥ç¸®æ¬„ä½†ä¸æœƒçˆ†ç‰ˆ */
    .cal-grid{
      display:grid;
      grid-template-columns: repeat(7, minmax(86px, 1fr));
      gap:10px;
      min-width: 700px; /* âœ… å°è¢å¹•æ™‚ç”¨ scroller æ¨ªå‘æ»‘ */
    }

    .dow{
      font-size:13px;
      font-weight:900;
      color:#666;
      text-align:center;
      padding:6px 0;
    }

    .day-cell{
      background:#fff;
      border:1px solid #eee;
      border-radius:14px;
      padding:10px;
      min-height:88px;
      box-shadow:0 1px 8px rgba(0,0,0,.05);
      cursor:pointer;
      position:relative;
      transition: transform .05s ease;
    }
    .day-cell:hover{ transform: translateY(-1px); }
    .day-cell.dim{ opacity:.45; }
    .day-cell.selected{ outline: 2px solid #111; }
    .day-cell:focus-visible{ outline: var(--focus); outline-offset: 2px; }

    .day-num{ font-weight:900; font-size:16px; }
    .badges{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .badge{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:4px 8px;
      border-radius:999px;
      background:#f3f3f3;
      font-size:12px;
      font-weight:900;
    }

    /* day summary colors */
    .day-cell.ok{ background:#eef8f0; }     /* å…¨ DONE */
    .day-cell.mixed{ background:#fff7e6; }  /* DONE+MISSED */
    .day-cell.bad{ background:#fdeeee; }    /* æœ‰ MISSED */
    .day-cell.none{ background:#ffffff; }   /* æ²’è³‡æ–™ */

    .select{
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      font-weight: 900;
    }
    .select:focus-visible{ outline: var(--focus); outline-offset: 2px; }

    /* details list */
    .detail-box{
      margin-top: 14px;
      border-top: 1px solid #eee;
      padding-top: 12px;
    }
    .detail-title{
      font-weight: 900;
      margin-bottom: 8px;
      font-size: 18px;
    }
    .detail-item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:14px 0;
      border-bottom:1px solid #f1f1f1;
      flex-wrap:wrap;
    }
    .detail-left{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 240px;
    }
    .detail-left .muted{
      font-size: 15px; /* âœ… è—¥å“ */
      color: #444;
    }
    .pill{
      font-size: 14px; /* âœ… ç‹€æ…‹ */
      font-weight: 900;
      padding: 6px 12px;
      border-radius: 999px;
      background:#f3f3f3;
      display:inline-block;
      white-space: nowrap;
    }

    /* âœ… æ‰‹æ©Ÿ RWDï¼šå¡ç‰‡è®Š 1 æ¬„ï¼Œé¿å…è£åˆ‡ */
    @media (max-width: 900px){
      body{ padding: 14px; }
      header h2{ font-size: 22px; }
      .card{ width: 100%; }             /* é‡è¦ï¼šå¡ç‰‡æ»¿å¯¬ */
      .cal-title{ width:100%; }         /* æ¨™é¡Œæ›è¡Œ */
    }

    /* âœ… å°æ‰‹æ©Ÿï¼šæ§åˆ¶æŒ‰éˆ•æ›è¡Œã€é¿å…æ“ çˆ† */
    @media (max-width: 420px){
      .tab-btn{ width: 100%; text-align:center; }
      button, .select{ width: 100%; }
      .cal-head > div{ width: 100%; }
    }

    /* âœ… ç„¡éšœç¤™ï¼šæ¸›å°‘å‹•æ…‹æ•ˆæœ */
    @media (prefers-reduced-motion: reduce){
      .day-cell{ transition:none; }
      .day-cell:hover{ transform:none; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h2 aria-label="æ™ºæ…§è—¥ç›’å„€è¡¨æ¿">ğŸ’Š æ™ºæ…§è—¥ç›’ Dashboard</h2>
    </header>

    <!-- âœ… a11y tabs -->
    <div class="tabs" role="tablist" aria-label="é é¢åˆ‡æ›">
      <button id="tab-status" class="tab-btn active" role="tab" aria-selected="true" aria-controls="page-status">ğŸ“¡ ç‹€æ…‹ç¸½è¦½</button>
      <button id="tab-config" class="tab-btn" role="tab" aria-selected="false" aria-controls="page-config">âš™ï¸ æœè—¥è¨­å®š</button>
      <button id="tab-history" class="tab-btn" role="tab" aria-selected="false" aria-controls="page-history">ğŸ“’ æœè—¥ç´€éŒ„</button>
    </div>

    <main>
      <!-- ================= Status Page ================= -->
      <section id="page-status" class="page active" role="tabpanel" aria-labelledby="tab-status">
        <div class="row">
          <div class="card" aria-label="æ—©æ™¨ç‹€æ…‹å¡">
            <div class="muted">æ™‚æ®µ</div>
            <div class="slot">
              <div class="big">æ—©ï¼ˆMorningï¼‰</div>
              <div id="time-morning" class="time-tag" aria-label="æ—©æ™¨è¨­å®šæ™‚é–“">--:--</div>
            </div>

            <div class="muted">éœ€è¦æœç”¨è—¥ç‰©</div>
            <div id="meds-morning" class="big" aria-label="æ—©æ™¨è—¥ç‰©">--</div>

            <div class="muted">ç‹€æ…‹</div>
            <div id="state-morning" class="big" aria-label="æ—©æ™¨ç‹€æ…‹">--</div>

            <div class="muted">æœ€å¾Œæ›´æ–°</div>
            <div id="ts-morning" class="muted" aria-label="æ—©æ™¨æœ€å¾Œæ›´æ–°">--</div>
          </div>

          <div class="card" aria-label="ä¸­åˆç‹€æ…‹å¡">
            <div class="muted">æ™‚æ®µ</div>
            <div class="slot">
              <div class="big">ä¸­ï¼ˆNoonï¼‰</div>
              <div id="time-noon" class="time-tag" aria-label="ä¸­åˆè¨­å®šæ™‚é–“">--:--</div>
            </div>

            <div class="muted">éœ€è¦æœç”¨è—¥ç‰©</div>
            <div id="meds-noon" class="big" aria-label="ä¸­åˆè—¥ç‰©">--</div>

            <div class="muted">ç‹€æ…‹</div>
            <div id="state-noon" class="big" aria-label="ä¸­åˆç‹€æ…‹">--</div>

            <div class="muted">æœ€å¾Œæ›´æ–°</div>
            <div id="ts-noon" class="muted" aria-label="ä¸­åˆæœ€å¾Œæ›´æ–°">--</div>
          </div>

          <div class="card" aria-label="æ™šä¸Šç‹€æ…‹å¡">
            <div class="muted">æ™‚æ®µ</div>
            <div class="slot">
              <div class="big">æ™šï¼ˆNightï¼‰</div>
              <div id="time-night" class="time-tag" aria-label="æ™šä¸Šè¨­å®šæ™‚é–“">--:--</div>
            </div>

            <div class="muted">éœ€è¦æœç”¨è—¥ç‰©</div>
            <div id="meds-night" class="big" aria-label="æ™šä¸Šè—¥ç‰©">--</div>

            <div class="muted">ç‹€æ…‹</div>
            <div id="state-night" class="big" aria-label="æ™šä¸Šç‹€æ…‹">--</div>

            <div class="muted">æœ€å¾Œæ›´æ–°</div>
            <div id="ts-night" class="muted" aria-label="æ™šä¸Šæœ€å¾Œæ›´æ–°">--</div>
          </div>
        </div>
      </section>

      <!-- ================= Config Page ================= -->
      <section id="page-config" class="page" role="tabpanel" aria-labelledby="tab-config">
        <div class="row">
          <div class="card" style="width: 100%; max-width: 760px;" aria-label="æœè—¥è¨­å®š">
            <div class="big">âš™ï¸ æœè—¥è¨­å®šï¼ˆä¸‹ç™¼åˆ° Picoï¼‰</div>
            <div class="muted">æœƒ POST åˆ° /api/configï¼Œå¾Œç«¯å† publish MQTTï¼ˆretainedï¼‰ã€‚</div>

            <div style="height:10px;"></div>

            <label class="muted" for="t-morning">æ—©ï¼ˆmorningï¼‰æ™‚é–“</label>
            <input id="t-morning" type="time" value="08:00" aria-label="æ—©æ™¨æ™‚é–“">
            <label class="muted" for="m-morning">æ—© è—¥å“ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
            <input id="m-morning" type="text" placeholder="æ™®æ‹¿ç–¼1é¡†, ç¶­ä»–å‘½C500mg" aria-label="æ—©æ™¨è—¥å“">

            <label class="muted" for="t-noon">ä¸­ï¼ˆnoonï¼‰æ™‚é–“</label>
            <input id="t-noon" type="time" value="12:00" aria-label="ä¸­åˆæ™‚é–“">
            <label class="muted" for="m-noon">ä¸­ è—¥å“ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
            <input id="m-noon" type="text" placeholder="..." aria-label="ä¸­åˆè—¥å“">

            <label class="muted" for="t-night">æ™šï¼ˆnightï¼‰æ™‚é–“</label>
            <input id="t-night" type="time" value="20:00" aria-label="æ™šä¸Šæ™‚é–“">
            <label class="muted" for="m-night">æ™š è—¥å“ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
            <input id="m-night" type="text" placeholder="..." aria-label="æ™šä¸Šè—¥å“">

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button id="btn-load" class="btn-ghost" aria-label="è®€å–ç›®å‰è¨­å®š">è®€å–ç›®å‰è¨­å®š</button>
              <button id="btn-save" class="btn-primary" aria-label="é€å‡ºè¨­å®š">é€å‡ºè¨­å®šï¼ˆPublish MQTTï¼‰</button>
            </div>

            <div id="save-msg" class="msg" role="status" aria-live="polite"></div>
          </div>
        </div>
      </section>

      <!-- ================= History Page ================= -->
      <section id="page-history" class="page" role="tabpanel" aria-labelledby="tab-history">
        <div class="row">
          <div class="card" style="width: 100%;" aria-label="æœˆæ›†å¼æœè—¥ç´€éŒ„">
            <div class="big">ğŸ“’ æœˆæ›†å¼æœè—¥ç´€éŒ„</div>
            <div class="muted">è³‡æ–™ä¾†æºï¼šGET /api/history?days=30ï¼ˆDONE / MISSEDï¼‰ã€‚æ ¼å­é¡è‰²ï¼šâœ…=æ·¡ç¶ ã€âŒ=æ·¡ç´…ã€æ··åˆ=æ·¡é»ƒã€‚</div>

            <div class="cal-head" aria-label="æœˆæ›†æ“ä½œåˆ—">
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <button id="btn-prev-month" class="btn-ghost" aria-label="ä¸Šå€‹æœˆ">â—€ ä¸Šå€‹æœˆ</button>
                <button id="btn-today" class="btn-ghost" aria-label="å›åˆ°ä»Šå¤©">ä»Šå¤©</button>
                <select id="month-picker" class="select" aria-label="é¸æ“‡æœˆä»½"></select>
                <button id="btn-next-month" class="btn-ghost" aria-label="ä¸‹å€‹æœˆ">ä¸‹å€‹æœˆ â–¶</button>
              </div>
              <div id="cal-title" class="cal-title" aria-label="ç›®å‰é¡¯ç¤ºæœˆä»½">--</div>
            </div>

            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:4px;">
              <button id="btn-history" class="btn-primary" aria-label="é‡æ–°è¼‰å…¥è¿‘ä¸‰åå¤©ç´€éŒ„">é‡æ–°è¼‰å…¥ï¼ˆè¿‘ 30 å¤©ï¼‰</button>
              <div id="history-msg" class="msg" role="status" aria-live="polite"></div>
            </div>

            <div class="calendar-wrap">
              <!-- âœ… å°è¢å¹•å¯æ»‘å‹•ï¼Œé¿å…è£åˆ‡ -->
              <div class="calendar-scroller" aria-label="æœˆæ›†å€å¡Šï¼ˆå¯å·¦å³æ»‘å‹•ï¼‰">
                <div class="cal-grid" id="dow-row" aria-hidden="true">
                  <div class="dow">ä¸€</div><div class="dow">äºŒ</div><div class="dow">ä¸‰</div><div class="dow">å››</div><div class="dow">äº”</div><div class="dow">å…­</div><div class="dow">æ—¥</div>
                </div>
                <div class="cal-grid" id="cal-grid" role="grid" aria-label="æœˆæ›†æ—¥æœŸæ ¼"></div>
              </div>

              <div class="detail-box" aria-label="æ—¥æœŸè©³ç´°æ¸…å–®">
                <div id="detail-title" class="detail-title">é¸å–æ—¥æœŸï¼š--</div>
                <div id="detail-list" class="muted">é»é¸ä¸Šæ–¹æ—¥æœŸæ ¼å­æŸ¥çœ‹è©³ç´°ç´€éŒ„</div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
/* ========== API è¨­å®š ========== */
const API_BASE = "https://approvably-creamlaid-vanetta.ngrok-free.dev";
const API_STATE   = `${API_BASE}/api/state`;
const API_CONFIG  = `${API_BASE}/api/config`;
const API_HISTORY = `${API_BASE}/api/history?days=30`;

const FETCH_GET_OPTS = {
  cache: "no-store",
  headers: { "ngrok-skip-browser-warning": "true" }
};

function fetchPostJson(url, payloadObj) {
  return fetch(url, {
    method: "POST",
    cache: "no-store",
    headers: {
      "Content-Type": "application/json",
      "ngrok-skip-browser-warning": "true"
    },
    body: JSON.stringify(payloadObj)
  });
}

const STATUS_TEXT = {
  "IDLE": "å¾…æ©Ÿä¸­",
  "ALARMING": "â° æé†’ä¸­",
  "DONE": "âœ… å·²æœè—¥",
  "ACKED": "âœ… å·²æœè—¥",
  "MISSED": "âŒ æ¼æœ"
};

function fmtTs(sec) {
  if (sec === null || sec === undefined) return "--";
  const n = Number(sec);
  if (!Number.isFinite(n) || n <= 0) return "--";
  return new Date(n * 1000).toLocaleString();
}
function renderMeds(meds) {
  if (!meds) return "--";
  if (Array.isArray(meds)) return meds.length ? meds.join("ã€") : "--";
  const s = String(meds).trim();
  return s ? s : "--";
}
function renderTime(t) {
  const s = String(t || "").trim();
  return s ? s : "--:--";
}
function parseMeds(text) {
  return text.split(",").map(s => s.trim()).filter(Boolean);
}

/* ========== State polling ========== */
let stateTimer = null;

async function refreshState() {
  try {
    const r = await fetch(API_STATE, FETCH_GET_OPTS);
    const data = await r.json();

    ["morning", "noon", "night"].forEach(box => {
      const stateEl = document.getElementById(`state-${box}`);
      const tsEl = document.getElementById(`ts-${box}`);

      if (data[box]) {
        stateEl.textContent = STATUS_TEXT[data[box].state] ?? data[box].state;
        tsEl.textContent = fmtTs(data[box].recv_ts);
      } else {
        stateEl.textContent = "--";
        tsEl.textContent = "--";
      }
    });
  } catch (e) {
    ["morning","noon","night"].forEach(box=>{
      document.getElementById(`state-${box}`).textContent = "å¾Œç«¯æœªé€£ç·š";
      document.getElementById(`ts-${box}`).textContent = "--";
    });
  }
}
function startStatePolling() {
  if (stateTimer) return;
  refreshState();
  stateTimer = setInterval(refreshState, 1000);
}
function stopStatePolling() {
  if (!stateTimer) return;
  clearInterval(stateTimer);
  stateTimer = null;
}

/* ========== Config ========== */
function fillFromConfig(cfg) {
  const boxes = cfg?.boxes || {};
  ["morning","noon","night"].forEach(box=>{
    const medsEl = document.getElementById(`meds-${box}`);
    const timeEl = document.getElementById(`time-${box}`);

    if (boxes[box]) {
      const t = boxes[box].time || "00:00";
      const meds = boxes[box].meds || [];

      document.getElementById(`t-${box}`).value = t;
      document.getElementById(`m-${box}`).value = Array.isArray(meds) ? meds.join(", ") : String(meds);

      if (medsEl) medsEl.textContent = renderMeds(meds);
      if (timeEl) timeEl.textContent = renderTime(t);
    } else {
      if (medsEl) medsEl.textContent = "--";
      if (timeEl) timeEl.textContent = "--:--";
    }
  });
}
async function loadConfig() {
  const msg = document.getElementById("save-msg");
  if (msg) msg.textContent = "è®€å–è¨­å®šä¸­...";

  const r = await fetch(API_CONFIG, FETCH_GET_OPTS);
  const cfg = await r.json();
  fillFromConfig(cfg);

  if (msg) msg.textContent = `âœ… å·²è®€å–è¨­å®šï¼ˆæœ€å¾Œè¨­å®šï¼š${fmtTs(cfg.updated_ts)}ï¼‰`;
}
async function saveConfig() {
  const msg = document.getElementById("save-msg");
  if (msg) msg.textContent = "é€å‡ºä¸­...";

  const payload = {
    boxes: {
      morning: { time: document.getElementById("t-morning").value, meds: parseMeds(document.getElementById("m-morning").value) },
      noon:    { time: document.getElementById("t-noon").value,    meds: parseMeds(document.getElementById("m-noon").value) },
      night:   { time: document.getElementById("t-night").value,   meds: parseMeds(document.getElementById("m-night").value) },
    }
  };

  const r = await fetchPostJson(API_CONFIG, payload);
  const data = await r.json();
  if (!r.ok) throw new Error(data.detail || "POST /api/config failed");

  if (msg) msg.textContent = `âœ… å·²é€å‡ºè¨­å®šä¸¦ publish MQTTï¼ˆæœ€å¾Œè¨­å®šï¼š${fmtTs(data.updated_ts)}ï¼‰`;
  loadConfig().catch(()=>{});
}

/* ========== Calendar History (Month view) ========== */
let historyRows = [];
let dayMap = new Map();
let calCursor = new Date();
let selectedDateStr = null;

function pad2(n){ return String(n).padStart(2,"0"); }
function ymd(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function monthKey(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }
function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
function mondayBasedDow(d){
  const js = d.getDay();
  return (js + 6) % 7;
}
function monthTitle(d){
  return `${d.getFullYear()} å¹´ ${pad2(d.getMonth()+1)} æœˆ`;
}
function buildDayMap(rows){
  const m = new Map();
  for (const x of rows) {
    const ts = x.device_ts ? String(x.device_ts) : "";
    const dateStr = ts ? ts.slice(0,10) : null;
    if (!dateStr) continue;
    if (!m.has(dateStr)) m.set(dateStr, []);
    m.get(dateStr).push(x);
  }
  for (const [k, arr] of m.entries()) {
    arr.sort((a,b) => {
      const ta = (a.device_ts || "").slice(11,19);
      const tb = (b.device_ts || "").slice(11,19);
      return tb.localeCompare(ta);
    });
  }
  return m;
}
function daySummaryClass(rows) {
  if (!rows || !rows.length) return "none";
  const doneCnt = rows.filter(r => r.state === "DONE").length;
  const missCnt = rows.filter(r => r.state === "MISSED").length;
  if (missCnt > 0 && doneCnt === 0) return "bad";
  if (missCnt > 0 && doneCnt > 0) return "mixed";
  if (missCnt === 0 && doneCnt > 0) return "ok";
  return "none";
}
function buildMonthPicker() {
  const sel = document.getElementById("month-picker");
  if (!sel) return;

  const base = new Date();
  const start = new Date(base.getFullYear(), base.getMonth() - 12, 1);

  sel.innerHTML = "";
  for (let i = 0; i < 25; i++) {
    const d = new Date(start.getFullYear(), start.getMonth() + i, 1);
    const opt = document.createElement("option");
    opt.value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    opt.textContent = `${d.getFullYear()} / ${pad2(d.getMonth()+1)}`;
    sel.appendChild(opt);
  }
  sel.value = monthKey(calCursor);
}
function setMonthPickerToCursor() {
  const sel = document.getElementById("month-picker");
  if (!sel) return;
  sel.value = monthKey(calCursor);
}
function boxLabel(box){
  if (box === "morning") return "æ—©ï¼ˆMorningï¼‰";
  if (box === "noon") return "ä¸­ï¼ˆNoonï¼‰";
  if (box === "night") return "æ™šï¼ˆNightï¼‰";
  return box || "--";
}
function renderDayDetails(dateStr){
  const title = document.getElementById("detail-title");
  const list = document.getElementById("detail-list");

  title.textContent = `é¸å–æ—¥æœŸï¼š${dateStr}`;

  const rows = (dayMap.get(dateStr) || []).slice();
  if (!rows.length) {
    list.className = "muted";
    list.textContent = "ï¼ˆç•¶å¤©æ²’æœ‰ DONE / MISSED ç´€éŒ„ï¼‰";
    return;
  }

  list.className = "";
  list.innerHTML = rows.map(x => {
    const timeStr = x.device_ts ? String(x.device_ts).slice(11,19) : "--:--:--";
    const medsStr = renderMeds(x.meds || []);
    const pill = (x.state === "DONE")
      ? `<span class="pill" aria-label="å·²æœè—¥">âœ… å·²æœè—¥</span>`
      : `<span class="pill" aria-label="æ¼æœ">âŒ æ¼æœ</span>`;

    return `
      <div class="detail-item">
        <div class="detail-left">
          <div><b>${timeStr}</b>ã€€${boxLabel(x.box)}</div>
          <div class="muted">è—¥å“ï¼š${medsStr}</div>
        </div>
        <div>${pill}</div>
      </div>
    `;
  }).join("");
}

function renderCalendar(){
  const gridEl = document.getElementById("cal-grid");
  const titleEl = document.getElementById("cal-title");
  titleEl.textContent = monthTitle(calCursor);

  buildMonthPicker();
  setMonthPickerToCursor();

  const m0 = startOfMonth(calCursor);
  const m1 = endOfMonth(calCursor);

  const start = new Date(m0);
  start.setDate(start.getDate() - mondayBasedDow(m0));

  const end = new Date(m1);
  end.setDate(end.getDate() + (6 - mondayBasedDow(m1)));

  const cells = [];
  for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
    const dateStr = ymd(d);
    const isThisMonth = d.getMonth() === calCursor.getMonth();
    const rows = dayMap.get(dateStr) || [];
    const cls = daySummaryClass(rows);
    const isSelected = selectedDateStr === dateStr;

    const doneCnt = rows.filter(r => r.state === "DONE").length;
    const missCnt = rows.filter(r => r.state === "MISSED").length;

    let badges = "";
    if (doneCnt) badges += `<span class="badge">âœ… ${doneCnt}</span>`;
    if (missCnt) badges += `<span class="badge">âŒ ${missCnt}</span>`;
    if (!badges) badges = `<span class="badge">â€”</span>`;

    // âœ… å¯éµç›¤æ“ä½œï¼šbutton role + tabindex
    cells.push(`
      <div class="day-cell ${cls} ${isThisMonth ? "" : "dim"} ${isSelected ? "selected" : ""}"
           role="button"
           tabindex="0"
           aria-label="${dateStr}ï¼Œå·²æœè—¥ ${doneCnt} ç­†ï¼Œæ¼æœ ${missCnt} ç­†"
           data-date="${dateStr}">
        <div class="day-num">${d.getDate()}</div>
        <div class="badges">${badges}</div>
      </div>
    `);
  }

  gridEl.innerHTML = cells.join("");

  const activate = (dateStr) => {
    selectedDateStr = dateStr;
    renderCalendar();
    renderDayDetails(selectedDateStr);
  };

  gridEl.querySelectorAll(".day-cell").forEach(el => {
    el.addEventListener("click", () => activate(el.getAttribute("data-date")));
    el.addEventListener("keydown", (ev) => {
      if (ev.key === "Enter" || ev.key === " ") {
        ev.preventDefault();
        activate(el.getAttribute("data-date"));
      }
    });
  });

  if (!selectedDateStr) {
    selectedDateStr = ymd(new Date());
    renderDayDetails(selectedDateStr);
    renderCalendar();
    return;
  }
}

async function loadHistory(){
  const msg = document.getElementById("history-msg");
  if (msg) msg.textContent = "è¼‰å…¥ä¸­...";

  const r = await fetch(API_HISTORY, FETCH_GET_OPTS);
  const data = await r.json();
  if (!r.ok) throw new Error(data.detail || "GET /api/history failed");

  historyRows = (data.rows || []).filter(x => (x.state === "DONE" || x.state === "MISSED"));
  dayMap = buildDayMap(historyRows);

  if (msg) msg.textContent = `âœ… å·²è¼‰å…¥ï¼ˆ${historyRows.length} ç­†ï¼Œè¿‘ ${data.days ?? 30} å¤©ï¼‰`;

  renderCalendar();
}

/* ========== Tabs ========== */
function setActiveTab(which) {
  const tabs = [
    {btn:"tab-status", page:"page-status"},
    {btn:"tab-config", page:"page-config"},
    {btn:"tab-history", page:"page-history"},
  ];

  tabs.forEach(t=>{
    const b = document.getElementById(t.btn);
    const p = document.getElementById(t.page);
    const active = (which === t.page.replace("page-",""));
    b.classList.toggle("active", active);
    b.setAttribute("aria-selected", active ? "true" : "false");
    p.classList.toggle("active", active);
  });

  if (which === "status") { startStatePolling(); }
  else { stopStatePolling(); }

  if (which === "config") loadConfig().catch(()=>{});
  if (which === "history") loadHistory().catch(err=>{
    document.getElementById("history-msg").textContent = `âŒ è¼‰å…¥å¤±æ•—ï¼š${err.message}`;
  });
}

/* ========== Events ========== */
document.getElementById("tab-status").addEventListener("click", () => setActiveTab("status"));
document.getElementById("tab-config").addEventListener("click", () => setActiveTab("config"));
document.getElementById("tab-history").addEventListener("click", () => setActiveTab("history"));

document.getElementById("btn-load").addEventListener("click", () => {
  loadConfig().catch(err => {
    document.getElementById("save-msg").textContent = `âŒ è®€å–å¤±æ•—ï¼š${err.message}`;
  });
});

document.getElementById("btn-save").addEventListener("click", () => {
  saveConfig().catch(err => {
    document.getElementById("save-msg").textContent = `âŒ é€å‡ºå¤±æ•—ï¼š${err.message}`;
  });
});

document.getElementById("btn-history").addEventListener("click", () => {
  loadHistory().catch(err => {
    document.getElementById("history-msg").textContent = `âŒ è¼‰å…¥å¤±æ•—ï¼š${err.message}`;
  });
});

document.getElementById("btn-prev-month").addEventListener("click", () => {
  calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth() - 1, 1);
  selectedDateStr = null;
  renderCalendar();
});

document.getElementById("btn-next-month").addEventListener("click", () => {
  calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth() + 1, 1);
  selectedDateStr = null;
  renderCalendar();
});

document.getElementById("btn-today").addEventListener("click", () => {
  calCursor = new Date();
  selectedDateStr = ymd(new Date());
  renderCalendar();
  renderDayDetails(selectedDateStr);
});

document.getElementById("month-picker").addEventListener("change", (e) => {
  const v = e.target.value; // YYYY-MM
  const [y, m] = v.split("-").map(Number);
  calCursor = new Date(y, m - 1, 1);
  selectedDateStr = null;
  renderCalendar();
});

/* ========== init ========== */
loadConfig().catch(()=>{});
setActiveTab("status");
</script>
</body>
</html>
